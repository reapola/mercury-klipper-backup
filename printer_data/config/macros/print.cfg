#####################################################################
#   Macros
#####################################################################

   
######################### PRINT START / END #########################
[gcode_macro Enable_Features]
variable_nozzle_wiper:  False
variable_status_led:    False
gcode:


[gcode_macro Print_Start]
gcode:    
    {% set target_extruder = params.EXTRUDER|default(260)|int %}
    {% set target_bed = params.BED|default(110)|int %}
    {% set target_chamber = params.CHAMBER|default(0)|int %}
    {% set start_chambertemp = target_chamber - 5 %}
    {% set target_beacon = params.BEACON_TARGET|default(65)|int %}
    {% set OFFSET = params.OFFSET|default(0)|float %}
    {% set RESET = params.RESET|default('True')|string %}
    {% set Prime = params.Prime|default('True')|string %}
    {% set nozzle_wiper = printer["gcode_macro Enable_Features"].nozzle_wiper %}
    ;SET_PRESSURE_ADVANCE ADVANCE={PA}
    #Do this in your slicer

    _SET_MPC_MATERIAL MATERIAL={params.MATERIAL}

    SET_LED_EFFECT EFFECT=homing REPLACE=1 
    RESPOND MSG="File Received"
    BED_MESH_CLEAR
    SET_VELOCITY_LIMIT VELOCITY=800 ACCEL=25000

    SET_GCODE_OFFSET Z=0
    G28 METHOD=PROXIMITY ; Home using proximity to get close to avoid the slow creep down when z is high
    G28 Z METHOD=CONTACT CALIBRATE=0 #Contact for true z
    G90
    G0 Z2   ; position beacon at 2mm for heat soak
    
    SET_FAN_SPEED FAN=nevermore SPEED=1 
     
    # if bed is within 10%, dont wait around
    {% set current_bed_temp = printer.heater_bed.temperature %}
    {% set tolerance_percentage = 0.10 %}  # 10% tolerance
    {% set lower_bound = target_bed * (1 - tolerance_percentage) %}
    
    M140 S{target_bed}     ; start bed heater
    M109 S150       ; preheat nozzle to probing temp
    M190 S{target_bed}     ; wait on bed temperature  

    SET_LED_EFFECT EFFECT=heating REPLACE=1

    {% if current_bed_temp < lower_bound %}
        RESPOND MSG="Bed temp outside 10% tolerance. Heating..."
        
        M190 S{target_bed}  ; Wait for bed to reach target temperature

        RESPOND MSG="Bed preheated!"
    {% else %}
        # make sure we still set where we want it to be eventually, but do not wait
        M140 S{target_bed}  ; Set bed target temperature
        RESPOND MSG="Bed already within 10% of {target_bed}C"
    {% endif %}
	
    RESPOND MSG="Waiting for chamber to reach: {start_chambertemp}c"           # Displays info

	{% if start_chambertemp > 10 %}
      TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={start_chambertemp}   ; wait for chamber temp
    {% else %}
      RESPOND MSG="Chamber already above {target_chamber}c"                    ; - if chamber is already at temp:
      TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM=0   ; wait for chamber temp
    {% endif %}


    # Heating nozzle to 150 degrees. This helps with getting a correct Z-home
    RESPOND MSG="Hotend: 150c"          # Displays info
    M109 S150       

    SET_LED_EFFECT EFFECT=calibrating_z REPLACE=1
    
    RESPOND MSG="Calibrating z"
    Go_To_Purge_Location
    Wipe_Nozzle
    G28 Z METHOD=CONTACT CALIBRATE=1    ; calibrate z offset and beacon model
    
    SET_LED_EFFECT EFFECT=leveling REPLACE=1
    RESPOND MSG="Sorting the tilt"
    Z_TILT_ADJUST
    
    SET_LED_EFFECT EFFECT=meshing REPLACE=1
    RESPOND MSG="Creating Mesh"
    BED_MESH_CALIBRATE RUNS=2 ADAPTIVE=1

    RESPOND MSG="Doing bed mesh check..."
    BED_MESH_CHECK MAX_DEVIATION=0.15

    Go_To_Purge_Location
    RESPOND MSG="Hotend target: {target_extruder}c"             # Displays info
    M104 S{target_extruder}                    ; set extruder to print temp
    M109 S{target_extruder}                    ; wait for extruder temp
    G4 P20000                           ; give the hot block 20s to stabilize
    
    RESPOND MSG="Wiping nozzle"
    G0 E-1.2 F1800          # retract additional filament to move out of melt zone
    G4 P4000
    Wipe_Nozzle        #clean nozzle
    G4 P4000
    Wipe_Nozzle        #clean nozzle
    G4 P4000
    Wipe_Nozzle        #clean nozzle
    G28 Z METHOD=CONTACT CALIBRATE=0    ; calibrate z offset only with hot nozzle
    SET_GCODE_OFFSET Z_ADJUST={OFFSET}  ; apply optional material squish via slicer
    SET_GCODE_OFFSET Z=0.02     ; add a little offset for hotend thermal expansion
    Go_To_Purge_Location
    Wipe_Nozzle        #clean nozzle
    
    SET_FAN_SPEED FAN=nevermore SPEED=0.5
    
    RESPOND MSG="Purging"
	SQUIGGLY_PURGE ADAPTIVE_MODE=1 LINE_MARGIN=15
    
    RESPOND MSG="Printer goes brr"          # Displays info
    SET_LED_EFFECT EFFECT=printing REPLACE=1                                                                                ; reset Extruder                                           
    

[gcode_macro Print_End]
gcode:
    RESPOND MSG="Done"
    CLEAR_ACTIVE_SPOOL
    RESET_VELOCITY_LIMIT
    
    M400
    G91                       ; relative positioning
    G1 E-6 F4800              ; retract
    G1 Z+1 X-2 Y-2 F6000
    G1 E-2 F500               ; short quick move to disengage from print

    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
	{% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
	{% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}
	
	{% if printer.toolhead.position.x < (max_x - 20) %}
	{% set x_safe = 20.0 %}
	{% else %}
	{% set x_safe = -20.0 %}
	{% endif %}
	
	{% if printer.toolhead.position.y < (max_y - 20) %}
	{% set y_safe = 20.0 %}
	{% else %}
	{% set y_safe = -20.0 %}
	{% endif %}
	
	{% if printer.toolhead.position.z < (max_z - 50) %}
	{% set z_safe = 50.0 %}
	{% else %}
	{% set z_safe = max_z - printer.toolhead.position.z %}
	{% endif %}
	
	G0 X{x_safe} Y{y_safe} Z{z_safe} F30000
    
    G0 E-1.2 F1800          # retract additional filament to move out of melt zone
    M221 S100                   ; reset flow
    M104 S0                     ; turn off hotend
    M140 S0                     ; turn off heatbed
    M107                        ; turn off fan
    G92 E0
    PARK_NOZZLE
    SET_FAN_SPEED FAN=nevermore SPEED=0.0 
    RESPOND MSG="Finished"
    M84                         ; disable motors
    leds_idle 
    ;SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=hotend_fan TARGET=45 min_speed=0 max_speed=1
######################## PAUSE/RESUME/CANCEL #########################

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode: 

	TURN_OFF_HEATERS
	CANCEL_PRINT_BASE
	PRINT_END


[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
gcode:
	{% if printer['pause_resume'].is_paused|int == 0 %}
	SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}
	
	SAVE_GCODE_STATE NAME=PAUSE
	BASE_PAUSE
	G90
	PARK_NOZZLE
	SAVE_GCODE_STATE NAME=PAUSEPARK
	SET_IDLE_TIMEOUT TIMEOUT=43200
	{% endif %}

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_etemp: 0
variable_m600: 0
gcode: 
	{% if printer['pause_resume'].is_paused|int == 1 %}
	SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
	{% if etemp > 0 %}
	M109 S{etemp|int}
	{% endif %}
	
	{% if m600 > 0 %}
	LOAD_FILAMENT
	PARK_NOZZLE
	M83
	G1 E25 F300
	WIPE_NOZZLE
	SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=m600 VALUE=0
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=500
	G91
	M83
	RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=500
	BASE_RESUME
	{% endif %}

[gcode_macro CLEAR_PAUSE]
rename_existing: BASE_CLEAR_PAUSE
gcode:
    {% set status_led = printer["gcode_macro Enable_Features"].status_led %}

    BASE_CLEAR_PAUSE
    {% if status_led %}
        Update_Status_LED
    {% endif %}



######################### MISC #########################

[gcode_macro G32]
gcode:
  {% if "z" not in printer.toolhead.homed_axes %} ; G28 Home if needed
    RESPOND MSG="Homing"
    G28
  {% endif %}
  Z_TILT_ADJUST
  G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing: Z_TILT_ADJUST_BASE
gcode:
    Z_TILT_ADJUST_BASE RETRY_TOLERANCE=1.0
    Z_TILT_ADJUST_BASE HORIZONTAL_MOVE_Z=2

[gcode_macro COLD_PULL]
gcode:
    {% set EXTRUDER = params.EXTRUDER|default(235) %}
    {% set PULLTEMP = params.PULLTEMP|default(80) %}
    G90
    M83
    G92 E0
    M109 S{EXTRUDER} 
    M104 S{PULLTEMP}
    M106 S120   #fan on
    G1 E5 F5
    M109 S{PULLTEMP}
    G1 E-15 F45
    G1 E-100 F300
    G92 E0
    M106 S0
    M104 S0
    M84

[gcode_macro PARK_NOZZLE]
description: Park the nozzle
gcode: 
	SAVE_GCODE_STATE NAME=PARKNOZZLE
	CONDITIONAL_HOME
	G90
	G0 X-6 Y113 F30000
	RESTORE_GCODE_STATE NAME=PARKNOZZLE

[gcode_macro CENTER_NOZZLE]
description: Center the nozzle
gcode: 
	SAVE_GCODE_STATE NAME=CENTERNOZZLE
	CONDITIONAL_HOME
	G90
	G0 X90 Y90 F30000
	RESTORE_GCODE_STATE NAME=CENTERNOZZLE

[gcode_macro _SET_MPC_MATERIAL]
description: Set heater MPC parameters for a given material
variable_filament_table:
    ## Update this table to adjust material settings
    {
        ## ( density, heat capacity )  # suggested heat capacity range
        "PLA"       : ( 1.25, 2.20 ),  # 1.80 - 2.20
        "PETG"      : ( 1.27, 2.20 ),  # 1.70 - 2.20
        "PC+ABS"    : ( 1.15, 2.20 ),  # 1.50 - 2.20
        "ABS"       : ( 1.06, 2.40 ),  # 1.25 - 2.40
        "ABS+"      : ( 1.06, 2.40 ),  # 1.25 - 2.40
        "ASA"       : ( 1.07, 2.10 ),  # 1.30 - 2.10
        "PA6"       : ( 1.12, 2.50 ),  # 2.00 - 2.50
        "PA"        : ( 1.15, 2.50 ),  # 2.00 - 2.50
        "PC"        : ( 1.20, 1.90 ),  # 1.10 - 1.90
        "TPU"       : ( 1.21, 2.00 ),  # 1.50 - 2.00
        "TPU-90A"   : ( 1.15, 2.00 ),  # 1.50 - 2.00
        "TPU-95A"   : ( 1.22, 2.00 ),  # 1.50 - 2.00
        "ABS-CF"    : ( 1.11, 2.40 ),  # 1.25 - 2.40
        "ASA-CF"    : ( 1.11, 2.10 ),  # 1.30 - 2.10
        "PA6-CF"    : ( 1.19, 2.50 ),  # 2.00 - 2.50
        "PC+ABS-CF" : ( 1.22, 2.20 ),  # 1.50 - 2.20
        "PC+CF"     : ( 1.36, 1.90 ),  # 1.10 - 1.90
        "PLA-CF"    : ( 1.29, 2.20 ),  # 1.80 - 2.20
        "PETG-CF"   : ( 1.30, 2.20 ),  # 1.70 - 2.20
        "ABS-GF"    : ( 1.08, 2.40 ),  # 1.25 - 2.40
        "ASA-GF"    : ( 1.17, 2.10 ),  # 1.30 - 2.10
        "ASA-DIAMOND" : ( 1.14, 2.10 ),  # 1.30 - 2.10
    }
gcode:
    {% set material = params.MATERIAL | upper %}
    {% set heater = params.HEATER | default('extruder') %}
    {% set extruder_config = printer.configfile.settings[heater] %}

    {% if material in filament_table %}
        {% set (density, heat_capacity) = filament_table[material] %}

        RESPOND PREFIX=ðŸ”¥ MSG="Configured {heater} MPC for {material}. Density: {density}, Heat Capacity: {heat_capacity}"
    {% else %}
        {% set density = extruder_config.filament_density %}
        {% set heat_capacity=extruder_config.filament_heat_capacity %}

        RESPOND PREFIX=ðŸ”¥ MSG="Unknown material '{material}', using default mpc parameters for {heater}"
    {% endif %}

    MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}

[gcode_macro _LOW_TEMP_CHECK]
description: Check the nozzle is at temperature and heat it if needed
gcode: 
    {% set T = params.T|default(printer["gcode_macro _USER_VARIABLES_OTHER"].print_default_extruder_temp)|float %}

    {% if printer.extruder.target != 0 %}
        {% if printer.extruder.temperature < printer.extruder.target %}
            M109 S{printer.extruder.target|float} 
        {% endif %}
    {% else %}
        {% if printer.extruder.target < T %}
            M109 S{T}
        {% endif %}
    {% endif %}

# Replace M109 (Wait for Hotend Temperature) with TEMPERATURE_WAIT so we don't have to wait for PID to level off.
[gcode_macro M109] # Wait Hotend Temp
rename_existing: M109.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+5}   # Wait for hotend temp (within n degrees)
    {% endif %}


[gcode_macro _RESETSPEEDS]
gcode:
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} 
    SET_VELOCITY_LIMIT ACCEL={printer.configfile.settings.printer.max_accel}  
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={printer.configfile.settings.printer.square_corner_velocity} 

[gcode_macro PREHEAT]
description = Preheat
gcode: 
	{% set hotend = params.HOTEND|default(0)|int %}
	{% set bed = params.BED|default(0)|int %}
	
	M104 S{hotend}
	M140 S{bed}
	M106 S128

[gcode_macro M600]
gcode: 
	SAVE_GCODE_STATE NAME=M600
	UNLOAD_FILAMENT
	SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=m600 VALUE=1
	PAUSE
	RESTORE_GCODE_STATE NAME=M600

[gcode_macro HEATSOAK]
variable_beacon_tolerance: 10
gcode: 
	{% set bed = params.BED|default(110)|int %}
	{% set hotend = params.HOTEND|default(160)|int %}
	{% set chamber_wanted = params.CHAMBER|default(50)|int %}
	{% set wait = params.WAIT|default(0)|int %}
	
	PREHEAT HOTEND={hotend} BED={bed}
	
	#CONDITIONAL_HOME
    G28
	
	RESPOND MSG="Heating"
	
	G90
	G1 X90 Y90 Z2 F3600
	M106 S128
	
	{% if wait != 0 %}
	M190 S{bed}
	TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={chamber_wanted}
	{% endif %}


######################### FILAMENT #########################

[gcode_macro CHANGE_FILAMENT]
description: Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES_OTHER"].print_default_extruder_temp)|float %}

 	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
    PAUSE
    PARK
    UNLOAD_FILAMENT
    RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state


[gcode_macro UNLOAD_FILAMENT]
description: Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES_OTHER"].print_default_extruder_temp)|float %}
    {% set DISTANCE = params.DISTANCE|default(105)|float %}

	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}

    _TIP_SHAPING
    M83
    G1 E-20 F3600
    G4 P3000
    G1 E{DISTANCE|float * -1} F3000

	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state


[gcode_macro LOAD_FILAMENT]
description: Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES_OTHER"].print_default_extruder_temp)|float %}
    {% set DISTANCE = params.DISTANCE|default(105)|float %}

	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
    M83
	G92 E0
    G1 E{DISTANCE|float} F200
    G1 E50 F150
    
	G92 E0
    RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state

[gcode_macro _TIP_SHAPING]
description: Filament tip shaping sequence
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES_OTHER"].print_default_extruder_temp)|float %}

	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
    
    {% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %} # old pressure advance
    # we suppress pressure advance
    SET_PRESSURE_ADVANCE ADVANCE=0

    M82
    G92 E0
    G1 E2 F3600
    G1 E0 F3600
    G1 E3 F3600
    G1 E0 F3600
    G1 E4 F3600
    G1 E0 F3600

    # set last pressure advance
    SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state


[gcode_macro Nozzle_Wiper_Variables]
variable_purge_x:       -8  # x purge location
variable_purge_y:       113 # y purge location
variable_purge_x_entry: 0   # x entry location before going to the purge location
variable_purge_y_entry: 111 # y entry location before going to the purge location
variable_wipe_dx:       0   # distance to move in x from the purge position in order to wipe
variable_wipe_dy:       20 # distance to move in y from the purge position in order to wipe
variable_wipe_count:    2   # number of wipe cycles
variable_travel_speed:  300 # how fast travel speeds will be performed
variable_entry_speed:   100 # how fast to move from the entry location to the purge location
variable_wipe_speed:    50  # how fast to move when wiping
variable_purge_speed:   7   # how fast to extrude in mm/s when purging
variable_purge_fan:     32  # default fan speed out of 255 when purging
variable_wipe_fan:      64 # default fan speed out of 255 when wiping
gcode:

#   Move above the purge bucket
[gcode_macro Go_To_Purge_Location]
gcode:
    {% set Px = printer["gcode_macro Nozzle_Wiper_Variables"].purge_x|float %}
    {% set Py = printer["gcode_macro Nozzle_Wiper_Variables"].purge_y|float %}
    {% set Pxe = printer["gcode_macro Nozzle_Wiper_Variables"].purge_x_entry|float %}
    {% set Pye = printer["gcode_macro Nozzle_Wiper_Variables"].purge_y_entry|float %}
    {% set St = printer["gcode_macro Nozzle_Wiper_Variables"].travel_speed * 60 %}
    {% set Se = printer["gcode_macro Nozzle_Wiper_Variables"].entry_speed * 60 %}

    SAVE_GCODE_STATE NAME=Go_To_Purge_Location_state
    G90

    {% if not (printer.toolhead.position.x == Px and printer.toolhead.position.y == Py) %}
        G1 X{Pxe} Y{Pye} F{St}
        G1 X{Px} Y{Py} F{Se}
    {% endif %}

    RESTORE_GCODE_STATE NAME=Go_To_Purge_Location_state

#   Wipe the nozzle on the brass brush or silicone wiper
[gcode_macro Wipe_Nozzle]
# params:
#   OLD_FAN_SPEED
gcode:
    {% set OLD_FAN_SPEED = params.OLD_FAN_SPEED|default(-1)|int %}
    {% set Px = printer["gcode_macro Nozzle_Wiper_Variables"].purge_x|float %}
    {% set Py = printer["gcode_macro Nozzle_Wiper_Variables"].purge_y|float %}
    {% set Pxe = printer["gcode_macro Nozzle_Wiper_Variables"].purge_x_entry|float %}
    {% set Pye = printer["gcode_macro Nozzle_Wiper_Variables"].purge_y_entry|float %}
    {% set Wdx = printer["gcode_macro Nozzle_Wiper_Variables"].wipe_dx|float %}
    {% set Wdy = printer["gcode_macro Nozzle_Wiper_Variables"].wipe_dy|float %}
    {% set Wc = printer["gcode_macro Nozzle_Wiper_Variables"].wipe_count|int %}
    {% set Se = printer["gcode_macro Nozzle_Wiper_Variables"].entry_speed * 60 %}
    {% set Sw = printer["gcode_macro Nozzle_Wiper_Variables"].wipe_speed * 60 %}
    {% set Sf = printer["gcode_macro Nozzle_Wiper_Variables"].wipe_fan %}
    
    {% if OLD_FAN_SPEED == -1 %}
        {% set old_Sf = printer.fan.speed %}
    {% else %}
        {% set old_Sf = OLD_FAN_SPEED %}
    {% endif %}
    
    {% if printer.fan.speed < Sf %}
        {% set wait_for_fan = True %}
    {% else %}
        {% set wait_for_fan = False %}
    {% endif %}

    SAVE_GCODE_STATE NAME=Wipe_Nozzle_state
    G90

    # go to purge location
    Go_To_Purge_Location

    # set fan speed for wiping
    M106 S{Sf}
    
    # wait for fan to cool filament if needed
    {% if wait_for_fan %}
        G4 P800
    {% endif %}

    # wipe nozzle
    G1 X{Px + Wdx} Y{Py + Wdy} F12000
    {% for i in range(Wc) %}
        G1 X{Px} Y{Py} F{Sw}
        G1 X{Px + Wdx} Y{Py + Wdy} F{Sw}
    {% endfor %}

    # move away from wiper
    G1 X{Pxe + Wdx} Y{Pye + Wdy} F{Se}

    # restore fan speed
    M106 S{(old_Sf * 255)|int}

    RESTORE_GCODE_STATE NAME=Wipe_Nozzle_state

#   Purge material into the bucket
[gcode_macro Purge]
description: Extrude into the purge bucket and wipe the nozzle
# params:
#   EXACT_TEMP:     whether to cool to specified temperature if already above it
#   TEMPERATURE:    minimum extruder temperature before purging
#   FEED_AMOUNT:    length of material in mm to purge
#   MAX_FEED:       max extrude length for a single purge strip. Set to -1 to disable length limit.
gcode:
    {% set EXACT_TEMP = params.EXACT_TEMP|default(False) %}
    {% set TEMPERATURE = params.TEMPERATURE|default(230.0)|float %}
    {% set FEED_AMOUNT = params.FEED_AMOUNT|default(15.0)|float %}
    {% set MAX_FEED = params.MAX_FEED|default(8.0)|float %}

    {% set Sp = printer["gcode_macro Nozzle_Wiper_Variables"].purge_speed * 60 %}
    {% set Sf = printer["gcode_macro Nozzle_Wiper_Variables"].purge_fan %}
    {% set old_Sf = printer.fan.speed %}

    SAVE_GCODE_STATE NAME=Purge_state

    # make sure FEED_AMOUNT is at least 3 to avoid negative E movements
    {% if FEED_AMOUNT < 3 %}
        {% set FEED_AMOUNT = 3 %}
    {% endif %}
    
    # go to purge location
    Go_To_Purge_Location

    # wait for hotend
    {% if EXACT_TEMP|lower == 'true' or printer.extruder.temperature < TEMPERATURE %}
        M109 S{TEMPERATURE}
    {% endif %}

    # set fan speed for purging
    M106 S{Sf}

    # relative extrusion
    M83

    # if extrude length is unlimited, purge a single strip
    {% if MAX_FEED == -1 %}
        # extrude
        G1 E{FEED_AMOUNT - 3} F{Sp}
        G1 E3 F100

    # else purge multiple smaller strips
    {% else %}
        {% for i in range(((FEED_AMOUNT - 3) / MAX_FEED)|int) %}
            # go to purge location
            Go_To_Purge_Location
            
            # extrude
            G1 E{MAX_FEED - 3} F{Sp}
            G1 E3 F100

            # wait
            G4 P800

            # wipe the nozzle
            Wipe_Nozzle OLD_FAN_SPEED={Sf}
        {% endfor %}

        # purge remainder
        {% set remainder = (FEED_AMOUNT - 3)|int % MAX_FEED|int %}
        Go_To_Purge_Location
        G1 E{remainder} F{Sp}
        G1 E3 F100
    {% endif %}

    # reset E position
    G92 E0.0

    # wait
    G4 P800

    # wipe the nozzle
    Wipe_Nozzle OLD_FAN_SPEED={old_Sf}

    RESTORE_GCODE_STATE NAME=Purge_state

[gcode_macro Base_Load_Filament]
gcode:
    M117 Loading Filament...
    G92 E0.0
    G91
    
    {% if printer["gcode_macro Filament_Loading_Variables"].filament_loaded %}
        G1 E15 F500
    {% else %}
        G1 E40 F960
        G1 E50 F500 # used to be E55
        SET_GCODE_VARIABLE MACRO=Filament_Loading_Variables VARIABLE=filament_loaded VALUE=True
    {% endif %}

    G90
    G92 E0.0
    M400
    M117 Load Complete
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=5

[gcode_macro Base_Unload_Filament]
gcode:
    M117 Unloading Filament...
    G92 E0.0
    G91
    G1 E10 F400     ; extrude filament to get better blob on end
    G1 E-35 F1000   ; retract
    G1 E-45 F5200
    G90
    G92 E0.0
    M400
    SET_GCODE_VARIABLE MACRO=Filament_Loading_Variables VARIABLE=filament_loaded VALUE=False
    M117 Remove Filament Now!
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=5


######################### CONDITIONAL HOMING #########################


[gcode_macro CONDITIONAL_HOME]
gcode:
	{% if "xyz" not in printer.toolhead.homed_axes %}
    RESPOND MSG="Homing"
	G28
	{% endif %}
    
    
######################### ALIASES/SHORTCUTS #########################

# Just a shortcut to turn EVERYTHING off with one command (beds, heaters, motors, lights)
[gcode_macro OFF]
gcode:
    M84                                             ; turn steppers off
    TURN_OFF_HEATERS                                ; turn bed / hotend off
    M107                                            ; turn print cooling fan off


[gcode_macro resonance_calc]
gcode:
    AXES_SHAPER_CALIBRATION FREQ_END=110 HZ_PER_SEC=0.5    ;measure IS with max freq 110 and slow it down to 0.5hz per sec
